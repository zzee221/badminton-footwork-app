<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V2.4功能测试</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="supabase-config.js"></script>
    <script src="step-config.js"></script>
    <script src="auth.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        #results { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>V2.4版本功能测试</h1>
    
    <div class="test-section">
        <h3>1. Supabase连接测试</h3>
        <button onclick="testSupabaseConnection()">测试连接</button>
        <div id="connection-result"></div>
    </div>
    
    <div class="test-section">
        <h3>2. 步伐配置测试</h3>
        <button onclick="testStepConfig()">测试步伐配置</button>
        <div id="step-config-result"></div>
    </div>
    
    <div class="test-section">
        <h3>3. 用户认证测试</h3>
        <button onclick="testAuth()">测试认证</button>
        <div id="auth-result"></div>
    </div>
    
    <div class="test-section">
        <h3>4. 激活码测试</h3>
        <button onclick="testActivationCodes()">测试激活码</button>
        <div id="activation-result"></div>
    </div>
    
    <div id="results"></div>

    <script>
        function logResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${message}</div>`;
        }

        async function testSupabaseConnection() {
            try {
                logResult('connection-result', '正在测试Supabase连接...', 'info');
                
                const { data, error, count } = await supabase.from('profiles').select('*', { count: 'exact', head: true });
                
                if (error) {
                    logResult('connection-result', `连接失败: ${error.message}`, 'error');
                } else {
                    logResult('connection-result', `连接成功！profiles表有 ${count} 条记录`, 'success');
                }
            } catch (err) {
                logResult('connection-result', `连接异常: ${err.message}`, 'error');
            }
        }

        function testStepConfig() {
            try {
                logResult('step-config-result', '正在测试步伐配置...', 'info');
                
                const stepConfig = new StepConfig();
                const parallelSteps = Object.keys(stepConfig.stepConfig.parallel.steps);
                const forwardBackwardSteps = Object.keys(stepConfig.stepConfig['forward-backward'].steps);
                
                logResult('step-config-result', 
                    `步伐配置加载成功！<br>
                    平行启动: ${parallelSteps.length} 个步伐<br>
                    前后启动: ${forwardBackwardSteps.length} 个步伐<br>
                    总计: ${parallelSteps.length + forwardBackwardSteps.length} 个步伐`, 
                    'success'
                );
            } catch (err) {
                logResult('step-config-result', `步伐配置测试失败: ${err.message}`, 'error');
            }
        }

        async function testAuth() {
            try {
                logResult('auth-result', '正在测试认证系统...', 'info');
                
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error) {
                    logResult('auth-result', `认证系统正常，当前未登录`, 'info');
                } else {
                    logResult('auth-result', `认证系统正常，当前用户: ${user.email}`, 'success');
                }
            } catch (err) {
                logResult('auth-result', `认证系统测试失败: ${err.message}`, 'error');
            }
        }

        async function testActivationCodes() {
            try {
                logResult('activation-result', '正在测试激活码系统...', 'info');
                
                const { data, error } = await supabase
                    .from('activation_codes')
                    .select('*')
                    .limit(5);
                
                if (error) {
                    logResult('activation-result', `激活码系统测试失败: ${error.message}`, 'error');
                } else {
                    logResult('activation-result', 
                        `激活码系统正常！<br>
                        找到 ${data.length} 个激活码<br>
                        未使用: ${data.filter(c => !c.is_used).length} 个<br>
                        已使用: ${data.filter(c => c.is_used).length} 个`, 
                        'success'
                    );
                }
            } catch (err) {
                logResult('activation-result', `激活码系统测试失败: ${err.message}`, 'error');
            }
        }

        // 页面加载时自动测试
        window.addEventListener('load', function() {
            setTimeout(() => {
                testSupabaseConnection();
                testStepConfig();
                testAuth();
                testActivationCodes();
            }, 1000);
        });
    </script>
</body>
</html>